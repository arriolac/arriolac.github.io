
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Chris Arriola</title>
  <meta name="author" content="Chris Arriola">

   
  <meta name="description" content="Ramblings">
  
  <meta name="keywords" content="">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://chrisarriola.me">
  <link href="/favicon.png" rel="icon">
  <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Chris Arriola" type="application/atom+xml">
  <script src="/js/jquery.js"></script>
  <script src="/js/bootstrap-collapse.js"></script>
  <script src="/js/modernizr-2.0.js"></script>
  <script src="/js/octopress.js" type="text/javascript"></script>
  <script src="/js/application.js"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Roboto+Condensed|Roboto:400,300' rel='stylesheet' type='text/css'>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-21505560-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="navbar navbar-inverse navbar-static-top">
  	<div class="navbar-inner">
  	  <div class="container">
        <a class="btn btn-navbar" data-toggle="collapse" data-target=".navbar-responsive-collapse">
          <span class="fui-menu-24"></span>
        </a>
  	  	<div class="nav-collapse collapse navbar-responsive-collapse" style="height:0;">
  	      <ul class="nav">
    
        <li class="active"><a href="/index.html">Home</a></li>
    
        <li ><a href="/book">Book</a></li>
    
        <li ><a href="/cv">CV</a></li>
    
        <li ><a href="/about-me">About Me</a></li>
    
</ul>

<ul class="nav pull-right">
    
    <li><a href="http://github.com/arriolac" title="Github Profile"><i class="icon-github-sign social-navbar"></i></a></li>
    
    
    
    <li><a href="http://linkedin.com/in/chrisarriola" title="Linkedin Profile"><i class="icon-linkedin-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://twitter.com/arriolachris" title="Twitter Profile"><i class="icon-twitter-sign social-navbar"></i></a></li>
    
    
    <li><a href="http://plus.google.com/+ChrisArriola" title="Google+ Profile"><i class="icon-google-plus-sign social-navbar"></i></a></li>
    
    
    

    
</ul>

  	    </div>
  	  </div>
  	</div>
  </div>
  <div class="container" id="main">
      <div class="row-fluid">
        <div id="content">
          <div class="jumbotron">
  <div class="container">
    
      Chris Arriola
    
    <h3 class="tagline">
      
        Mobile app developer. Android enthusiast.
      
    </h3>
  </div>
</div>


<div class="blog-index">
  
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2017-07-06T09:40:26-05:00" pubdate data-updated="true">Jul 6<span>th</span>, 2017</time></h5>
          <div class="row-fluid">
          
          <a href="http://chrisarriola.me/blog/2017/07/06/using-observables-to-render-responsive-lists-an-rxjava-case-study-part-1-of-3/#disqus_thread">Comments </a> <span class="fui-bubble-16"></span>
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/android,/"><span class="badge">Android,</span></a>
          
          <a href="/blog/categories/freelancing,/"><span class="badge">Freelancing,</span></a>
          
          <a href="/blog/categories/pre/"><span class="badge">Pre</span></a>
          
          <a href="/blog/categories/rxjava,/"><span class="badge">RxJava,</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2017/07/06/using-observables-to-render-responsive-lists-an-rxjava-case-study-part-1-of-3/">Using Observables to Render Responsive Lists: An RxJava Case Study - Part 1 of 3</a></h1>
      <p><em>This post was originally posted on <a href="https://medium.com/joinpre/using-observables-to-render-responsive-lists-an-rxjava-case-study-part-1-of-3-53dd83af2c08">Medium</a>.</em></p>

<p>This is the 1st part of a 3 part series about how RxJava is used in <a href="https://pre.co/">Pre</a>, a location-based app for checking in and chatting with your best friends. In this first post, I will go over how we used Observables to compose a complex view that displays a list of items, specifically, the <em>dashboard</em> view.</p>

<p>If you are new to RxJava, I recommend <a href="http://chrisarriola.me/blog/2016/09/04/introduction-to-rxjava-for-android/">starting here</a>. You can also check out a <a href="https://leanpub.com/reactiveandroid">book</a> Angus Huang and I wrote if you would like a more comprehensive learning resource on RxJava.</p>

<p>Note that all of the code samples in this series are written in Kotlin. In addition to RxJava, we use RxKotlin which is a lightweight library that provides convenient extension functions to RxJava.</p>

<h2>Dashboard View</h2>

<p><img class="center" src="http://chrisarriola.me/images/pre_dashboard_view.jpg"></p>

<p>The dashboard view is the first view presented to the user upon logging in. It contains 2 sections: (1) a section displaying a list of recent check-ins from your friends, and (2) a section displaying a list of all your friends. The latter is displayed by querying the data layer for all of your friends, followed by querying the most recent message in the conversation thread for each of your friends. The state of the message will then determine if an unread indicator, or if a relative timestamp of when that message was sent, should be displayed.</p>

<p><img class="center" src="http://chrisarriola.me/images/pre_dashboard_unread.png" title="'Friend with unread message'" ></p>

<p><img class="center" src="http://chrisarriola.me/images/pre_dashboard_read.png" title="'Friend with no unread message'" ></p>

<p>Both the <em>Friend</em> and <em>Message</em> models are persisted in a local SQLite database. To prevent jankiness while scrolling, retrieving these models should be done before rendering the list. More specifically, we want to make sure that we have all of the Friend objects and the corresponding latest Message in memory before setting the list of friends to the Adapter of the RecyclerView.</p>

<p>Before we dive into Observables and how RxJava fits into the picture, let‚Äôs look at a few classes that compose the dashboard view. Note that even though some of the classes here have been shortened for brevity, the underlying concepts should be the same.</p>

<h2>Non-Reactive Parts</h2>

<h3>DashboardFriendViewModel</h3>

<p>On the dashboard, the <em>DashboardFriendViewModel</em> class is in charge of binding the <em>Friend</em> and <em>Message</em> models to a single friend view. True to the <em>ViewModel</em> design pattern, this class provides us with the benefit of abstracting away model details from the view layer. So if our model changes, we would only need to update the <em>ViewModel</em>‚Äôs code (i.e. <em>DashboardFriendViewModel</em>), and not the view‚Äôs code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>data class DashboardFriendViewModel(
</span><span class='line'>   val emoji: String,
</span><span class='line'>   val title: String,
</span><span class='line'>   val subtitle: String,
</span><span class='line'>   val hasUnread: Boolean
</span><span class='line'>) {
</span><span class='line'>   companion object Factory {
</span><span class='line'>       @JvmStatic fun create(
</span><span class='line'>           friend: Friend,
</span><span class='line'>           message: Message
</span><span class='line'>       ) : DashboardFriendViewModel {
</span><span class='line'>           // Factory logic goes here...
</span><span class='line'>       }
</span><span class='line'>   }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>DashboardFriendViewHolder</h3>

<p>Using a <em>DashboardFriendViewModel</em>, a <em>DashboardFriendViewHolder</em> (a subclass of <em>RecyclerView.ViewHolder</em>), can simply update the views it holds by getting the fields on the <em>DashboardFriendViewModel</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class DashboardFriendViewHolder(
</span><span class='line'>   parent: ViewGroup
</span><span class='line'>) : RecyclerView.ViewHolder(
</span><span class='line'>    LayoutInflater.from(parent.context).inflate(
</span><span class='line'>        R.layout.item_dashboard_friend, parent, false
</span><span class='line'>    )
</span><span class='line'>) {
</span><span class='line'> 
</span><span class='line'>   var viewModel: DashboardFriendViewModel? = null
</span><span class='line'>       set(value) {
</span><span class='line'>           field = value
</span><span class='line'>           value?.let {
</span><span class='line'>               textViewEmoji.text = it.emoji
</span><span class='line'>               textViewTitle.text = it.title
</span><span class='line'>               textViewSubtitle.text = it.subtitle
</span><span class='line'>               imageViewUnread.visibility = if (hasUnread) View.VISIBLE else View.GONE
</span><span class='line'>           }
</span><span class='line'>       }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h3>DashboardAdapter</h3>

<p>The backing adapter for the dashboard RecyclerView, <em>DashboardAdapter</em>, holds a list of <em>DashboardFriendViewModel</em> objects and binds each object to a <em>DashboardFriendViewHolder</em> (note that check-ins are excluded in the code sample below).</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class DashboardAdapter : 
</span><span class='line'>    RecyclerView.Adapter&lt;DashboardFriendViewHolder&gt;() {
</span><span class='line'>    var friendViewModels: List&lt;DashboardFriendViewModel&gt; = listOf()
</span><span class='line'>        set(value) {
</span><span class='line'>            field = value
</span><span class='line'>            notifyDataSetChanged()
</span><span class='line'>        }
</span><span class='line'>    override fun onBindViewHolder(
</span><span class='line'>        holder: DashboardFriendViewHolder, 
</span><span class='line'>        position: Int
</span><span class='line'>    ) {
</span><span class='line'>        holder.viewModel = friendViewModels[position]
</span><span class='line'>    }
</span><span class='line'>    override fun getItemCount(): Int = friendViewModels.size
</span><span class='line'>    override fun onCreateViewHolder(
</span><span class='line'>        parent: ViewGroup, 
</span><span class='line'>        viewType: Int
</span><span class='line'>    ): DashboardFriendViewHolder {
</span><span class='line'>        return DashboardFriendViewHolder(parent)
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>With these classes in mind, it should be clear that the role of the Activity is to provide the <em>DashboardAdapter</em> a list of <em>DashboardFriendViewModel</em> objects to construct the list of friends in the dashboard view. In the next section, we will look at the reactive elements that come into play to accomplish this.</p>

<h2>Reactive Parts</h2>

<p>Each model that is backed by a SQLite table has a corresponding data access object, or DAO for short, that is in charge of performing CRUD (create, read, update, and delete) operations. The DAO provides the application layer with a higher level abstraction when it needs to access models so that it doesn‚Äôt need to know how to perform complex SQLite queries.</p>

<h3>DAO</h3>

<p>DAOs in Pre are also designed to be reactive; that is, DAOs can provide data packaged as an Observable so that the requestor can continue to receive updates as the underlying model changes. The details of how these Observables are constructed will be covered in the 2nd part of this series. For now, assume that we have the following methods provided by <em>FriendDao</em> and <em>MessageDao</em>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>class FriendDao {
</span><span class='line'>    fun getAllFriends(): Observable&lt;List&lt;Friend&gt;&gt; {
</span><span class='line'>        // ...
</span><span class='line'>    }
</span><span class='line'>    fun getFriend(userId: String): Observable&lt;Friend&gt; {
</span><span class='line'>        // ...
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    // more methods here...
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>class MessageDao {
</span><span class='line'> 
</span><span class='line'>    fun getAllMessagesFrom(userId: String): Observable&lt;List&lt;Message&gt;&gt; {
</span><span class='line'>        // ...
</span><span class='line'>    }
</span><span class='line'>    fun getRecentMessageWith(userId: String): Observable&lt;Message&gt; {   
</span><span class='line'>        // ...
</span><span class='line'>    }
</span><span class='line'>    // more methods here...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>It is important to keep in mind that these methods return Observables that report changes to subscribers as the underlying data also changes. For example, if we subscribe to <em>FriendDao#getAllFriends()</em> and, at a later point, a new <em>Friend</em> is added, the observer would receive an updated list of friends via¬†<em>.onNext()</em> once the new friend is persisted in the database. This is really powerful as the mechanism for requesting initial data and for receiving updates will all be in the same place‚Ää‚Äî‚Ääthe observer.</p>

<p>In addition, all methods that return Observables in Pre‚Äôs DAOs run off the main thread. It is up to the subscriber to ultimately hop back to the main thread, via¬†<em>.observeOn()</em>, when necessary (e.g. when interacting with the view layer).</p>

<h2>Putting It All Together üèó</h2>

<p>Using <em>FriendDao</em> and <em>MessageDao</em> that supply us with Observables of <em>Friend</em> and <em>Message</em> objects, respectively, we can now construct the list of DashboardFriendViewModel objects and display our list of friends on the dashboard.</p>

<p>The lines of code that accomplish this are:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>friendDao.getAllFriends()
</span><span class='line'>    .switchMap { friends -&gt;
</span><span class='line'>        val observables = friends.map { friend -&gt;
</span><span class='line'>            messageDao.getRecentMessageWith(friend.userId)
</span><span class='line'>                .map { DashboardFriendViewModel.create(friend, it) }
</span><span class='line'>        }
</span><span class='line'>        Observable.combineLatest(observables) {
</span><span class='line'>            Arrays.copyOf(
</span><span class='line'>                it, 
</span><span class='line'>                it.size,
</span><span class='line'>                Array&lt;DashboardFriendViewModel&gt;::class.java
</span><span class='line'>            ).toList()
</span><span class='line'>        }
</span><span class='line'>    }.observeOn(AndroidSchedulers.mainThread())
</span><span class='line'>     .subscribe { adapter.friendViewModels = it }</span></code></pre></td></tr></table></div></figure>


<p>There‚Äôs quite a lot going on here so let‚Äôs look at it step-by-step:</p>

<ul>
<li><p>First, we retrieve all friends by calling the¬†.getAllFriends() method on a FriendDao object. As mentioned earlier, this Observable will first emit the list of friends as well as any changes to the user‚Äôs friends (i.e. a list of friends will be emitted as new friends are added, or as existing friends are removed/updated)</p></li>
<li><p>Next, we apply a¬†.switchMap() operator which maps the stream from a list of Friend objects to a list of DashboardFriendViewModel objects, the type we are ultimately interested in. We are using¬†.switchMap() here, instead of¬†.flatMap() or¬†.concatMap(), so that only the most recent Observable emission from¬†.switchMap() is observed and all other previous emissions will be considered stale. You can read about the difference between the operators on the ReactiveX wiki.</p></li>
<li><p>Within the¬†.switchMap() operator, we then convert friends into a list of Observable<DashboardFriendViewModel> by iterating through each friend and getting the most recent message with them followed by mapping that to a DashboardFriendViewModel.</p></li>
<li><p>We then combine the emissions of the list of Observable<DashboardFriendViewModel> using the¬†.combineLatest() operator, the result of which is then combined into a list of DashboardFriendViewModel objects which is propagated down to the observer. This operator allows downstream operators and observers to receive updates whenever there is a new message from a friend.</p></li>
<li><p>After the¬†.switchMap() operator, we then chain an¬†.observeOn() operator and make sure that the observer receives events on Android‚Äôs main thread.</p></li>
<li><p>Finally, we subscribe to the Observable after applying¬†.switchMap() and set the DashboardAdapter‚Äôs friendViewModels to the received emissions. Here, we are replacing the backing data set for the DashboardAdapter, which in turn invokes notifyDataSetChanged(). This can also be optimized by finding the items with changes and selectively applying notifiyItemChanged() or notifyItemRangeChanged().</p></li>
</ul>


<h2>Summary</h2>

<p>The solution above is brief and accomplishes our goal of displaying the dashboard view as well as keeping it up-to-date whenever there is new data. Having a reactive data layer at Pre enables this. By no means is this the only way to compose complex UI. However, I hope this post convinced you that working with Observables makes dealing with data that can come from different sources as well as coordinating concurrency an easier task.</p>

<hr />

<p>Pre is now available in the Google Play Store üéâ Get it <a href="https://play.google.com/store/apps/details?id=io.tsukemen.zarusoba">here</a>.</p>

<p>Subscribe at the bottom of this site if you want to be notified when the next post in the series goes out.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2017-06-12T14:44:00-05:00" pubdate data-updated="true">Jun 12<span>th</span>, 2017</time></h5>
          <div class="row-fluid">
          
          <a href="http://chrisarriola.me/blog/2017/06/12/announcing-new-book-reactive-programming-on-android-with-rxjava/#disqus_thread">Comments </a> <span class="fui-bubble-16"></span>
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/android,/"><span class="badge">Android,</span></a>
          
          <a href="/blog/categories/rxjava/"><span class="badge">RxJava</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2017/06/12/announcing-new-book-reactive-programming-on-android-with-rxjava/">Announcing New Book: Reactive Programming on Android with RxJava</a></h1>
      <p>I&rsquo;m very pleased to announce that a book that <a href="https://www.linkedin.com/in/ahuang13/">Angus Huang</a> and I started writing a few months back, <a href="https://leanpub.com/reactiveandroid">&ldquo;Reactive Programming on Android with RxJava&rdquo;</a>, is now published and available on LeanPub! üéâ</p>

<p><img class="center" src="http://chrisarriola.me/images/rxjava_my_book_with_angus.jpg"></p>

<h2>What is RxJava?</h2>

<p>RxJava‚Äîthe Java implementation of ReactiveX‚Äîwas open sourced and introduced to the developer community by Netflix back in 2013. At Netflix, RxJava had arisen as a need to solve scaling issues created by their previous <a href="https://medium.com/netflix-techblog/embracing-the-differences-inside-the-netflix-api-redesign-15fd8b3dc49d">one-size-fits-all API</a>.</p>

<p>The promise of reactive programming was that it would allow their teams to seamlessly compose complex asynchronous behavior into an easy-to-use API. Using these APIs, their client teams can then create custom end-points to optimize for the growing number of devices that Netflix supported without having to deal with the intricacies of server-side concurrent programming.</p>

<p>In a word, RxJava was supposed to <strong>simplify writing concurrent code</strong>.</p>

<p>Turns out, RxJava did fulfill its promise and is now <a href="https://medium.com/netflix-techblog/reactive-programming-in-the-netflix-api-with-rxjava-7811c3a1496a">the backbone of many Netflix back-end services</a>.</p>

<p>Outside of Netflix, RxJava has been adopted in other communities, including the Android community, as reactive programming can also help with developing mobile apps. As of today, RxJava is the go-to library for enabling reactive programming on Android. Surely, the number of stars it has on Github should be a strong signal.</p>

<p><img class="center" src="http://chrisarriola.me/images/github_rxjava_stars.png" title="RxJava is the most starred Java repository on Github as of June 2017" ></p>

<h2>Why Write a Book?</h2>

<p>We believe that reactive programing is shaping the way Android apps are being built. This is even evident in the direction Google is going with its new reactive-inspired <a href="https://developer.android.com/topic/libraries/architecture/index.html">Android Architecture Components</a> announced recently at Google IO &lsquo;17. With that said, we think it&rsquo;s important for Android developers to familiarize themselves with the reactive programming model.</p>

<p>This book is a collection of our knowledge on the subject taken from different sources around the web (i.e. blog posts, books, wikis, etc.). Our hope is that this book serves as a solid foundation for Android developers who are new to RxJava and want to start integrating it into their apps.</p>

<p>If you are interested in learning more, you can purchase or download a sample of the book <a href="https://leanpub.com/reactiveandroid">here</a>.</p>

<hr />

<p>Got any questions? Leave us a comment below.</p>

<p>Writing apps in Kotlin? Stay tuned for our <a href="https://leanpub.com/reactiveandroidrxkotlin">next book</a>.</p>

      
      
    </div>
  </div>



    </article>
    
    <hr>
    
  
  
    <article>
      

  <div class="row-fluid">
    <div class="span2 post-meta">
	  <h5 class="date-time">








  


<i class="icon-calendar-empty"></i> <time datetime="2017-03-06T06:14:25-06:00" pubdate data-updated="true">Mar 6<span>th</span>, 2017</time></h5>
          <div class="row-fluid">
          
          <a href="http://chrisarriola.me/blog/2017/03/06/reactive-modelling-on-android/#disqus_thread">Comments </a> <span class="fui-bubble-16"></span>
          
          </div>
          
          <div class="row-fluid">
          
          <a href="/blog/categories/android,/"><span class="badge">Android,</span></a>
          
          <a href="/blog/categories/rxjava/"><span class="badge">RxJava</span></a>
          
          </div>
          
    </div>
    <div class="span10 post-container">
      <h1 class="link"><a href="/blog/2017/03/06/reactive-modelling-on-android/">Reactive Modelling on Android</a></h1>
      <p><em>This post was originally published on <a href="https://www.toptal.com/android/simplify-concurrency-reactive-modelling-android?utm_source=Android+Weekly&amp;utm_campaign=258130a563-android-weekly-247&amp;utm_medium=email&amp;utm_term=0_4eb677ad19-258130a563-337833853">Toptal</a>.</em></p>

<p>Concurrency and asynchronicity are inherent to mobile programming.</p>

<p>Dealing with concurrency through imperative-style programming, which is what programming on Android generally involves, can be the cause of many problems. Using Reactive Programming with <a href="https://github.com/ReactiveX/RxJava">RxJava</a>, you can avoid potential concurrency problems by providing a cleaner and less error-prone solution.</p>

<p>Aside from simplifying concurrent, asynchronous tasks, RxJava also provides the ability to perform functional style operations that transform, combine, and aggregate emissions from an Observable until we achieve our desired result.</p>

<p><img class="center" src="http://chrisarriola.me/images/rxjava_3os.jpg"></p>

<p>By combining RxJava‚Äôs reactive paradigm and functional style operations, we can model a wide range of concurrency constructs in a reactive way, even in Android‚Äôs non-reactive world. In this article, you will learn how you can do exactly that. You will also learn how to adopt RxJava into an existing project incrementally.</p>

<p>If you are new to RxJava, I recommend reading the post <a href="https://www.toptal.com/android/functional-reactive-android-rxjava">here</a> which talks about some of the fundamentals of RxJava.</p>

<h2>Bridging Non-Reactive into the Reactive World</h2>

<p>One of the challenges of adding RxJava as one of the libraries to your project is that it fundamentally changes the way that you reason about your code.</p>

<p>RxJava requires you to think about data as being pushed rather than being pulled. While the concept itself is simple, changing a full codebase that is based on a pull paradigm can be a bit daunting. Although consistency is always ideal, you might not always have the privilege to make this transition throughout your entire code base all at once, so more of an incremental approach may be needed.</p>

<p>Consider the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * @return a list of users with blogs
</span><span class='line'> */
</span><span class='line'>public List&lt;User&gt; getUsersWithBlogs() {
</span><span class='line'>   final List&lt;User&gt; allUsers = UserCache.getAllUsers();
</span><span class='line'>   final List&lt;User&gt; usersWithBlogs = new ArrayList&lt;&gt;();
</span><span class='line'>   for (User user : allUsers) {
</span><span class='line'>       if (user.blog != null && !user.blog.isEmpty()) {
</span><span class='line'>           usersWithBlogs.add(user);
</span><span class='line'>       }
</span><span class='line'>   }
</span><span class='line'>   Collections.sort(usersWithBlogs, (user1, user2) -&gt; user1.name.compareTo(user2.name));
</span><span class='line'>   return usersWithBlogs;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>This function gets a list of <code>User</code> objects from the cache, filters each one based on whether or not the user has a blog, sorts them by the user‚Äôs name, and finally returns them to the caller. Looking at this snippet, we notice that many of these operations can take advantage of RxJava operators; e.g., <code>filter()</code> and <code>sorted()</code>.</p>

<p>Rewriting this snippet then gives us:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * @return a list of users with blogs
</span><span class='line'> */
</span><span class='line'>public Observable&lt;User&gt; getUsersWithBlogs() {
</span><span class='line'>   return Observable.fromIterable(UserCache.getAllUsers())
</span><span class='line'>                    .filter(user -&gt; user.blog != null && !user.blog.isEmpty())
</span><span class='line'>                    .sorted((user1, user2) -&gt; user1.name.compareTo(user2.name));
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The first line of the function converts the <code>List&lt;User&gt;</code> returned by <code>UserCache.getAllUsers()</code> to an <code>Observable&lt;User&gt;</code> via <code>fromIterable()</code>. This is the first step into making our code reactive. Now that we are operating on an <code>Observable</code>, this enables us to perform any <code>Observable</code> operator in the RxJava toolkit ‚Äì <code>filter()</code> and <code>sorted()</code> in this case.</p>

<p>There are a few other points to note about this change.</p>

<p>First, the method signature is no longer the same. This may not be a huge deal if this method call is only used in a few places and it‚Äôs easy to propagate the changes up to other areas of the stack; however, if it breaks clients relying on this method, that is problematic and the method signature should be reverted.</p>

<p>Second, RxJava is designed with laziness in mind. That is, no long operations should be performed when there are no subscribers to the <code>Observable</code>. With this modification, that assumption is no longer true since <code>UserCache.getAllUsers()</code> is invoked even before there are any subscribers.</p>

<h2>Leaving the Reactive World</h2>

<p>To address the first issue from our change, we can make use of any of the blocking operators available to an <code>Observable</code> such as <code>blockingFirst()</code> and <code>blockingNext()</code>. Essentially, both of these operators will block until an item is emitted downstream: <code>blockingFirst()</code> will return the first element emitted and finish, whereas <code>blockingNext()</code> will return an <code>Iterable</code> which allows you to perform a for-each loop on the underlying data (each iteration through the loop will block).</p>

<p>A side-effect of using a blocking operation that is important to be aware of, though, is that exceptions are thrown on the calling thread rather than being passed to an observer‚Äôs <code>onError()</code> method.</p>

<p>Using a blocking operator to change the method signature back to a <code>List&lt;User&gt;</code>, our snippet would now look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * @return a list of users with blogs
</span><span class='line'> */
</span><span class='line'>public List&lt;User&gt; getUsersWithBlogs() {
</span><span class='line'>   return Observable.fromIterable(UserCache.getAllUsers())
</span><span class='line'>           .filter(user -&gt; user.blog != null && !user.blog.isEmpty())
</span><span class='line'>           .sorted((user1, user2) -&gt; user1.name.compareTo(user2.name))
</span><span class='line'>           .toList()
</span><span class='line'>           .blockingGet();
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Before calling a blocking operator (i.e. <code>blockingGet()</code>) we first need to chain the aggregate operator <code>toList()</code> so that the stream is modified from an <code>Observable&lt;User&gt;</code> to a <code>Single&lt;List&lt;User&gt;&gt;</code> (a Single is a special type of Observable that only emits a single value in <code>onSuccess()</code>, or an error via <code>onError()</code>).</p>

<p>Afterwards, we can call the blocking operator <code>blockingGet()</code> which unwraps the <code>Single</code> and returns a <code>List&lt;User&gt;</code>.</p>

<p>Although RxJava supports this, as much as possible this should be avoided as this is not idiomatic reactive programming. When absolutely necessary though, blocking operators are a nice initial way of stepping out of the reactive world.</p>

<h2>The Lazy Approach</h2>

<p>As mentioned earlier, RxJava was designed with laziness in mind. That is, long-running operations should be delayed as long as possible (i.e., until a subscribe is invoked on an <code>Observable</code>). To make our solution lazy, we make use of the <code>defer()</code> operator.</p>

<p><img class="center" src="http://chrisarriola.me/images/rxjava_defer.jpg"></p>

<p><code>defer()</code> takes in an <code>ObservableSource</code> factory which creates an <code>Observable</code> for each new observer that subscribes. In our case, we want to return <code>Observable.fromIterable(UserCache.getAllUser())</code> whenever an observer subscribes.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * @return a list of users with blogs
</span><span class='line'> */
</span><span class='line'>public Observable&lt;User&gt; getUsersWithBlogs() {
</span><span class='line'>   return Observable.defer(() -&gt; Observable.fromIterable(UserCache.getAllUsers()))
</span><span class='line'>                    .filter(user -&gt; user.blog != null && !user.blog.isEmpty())
</span><span class='line'>                    .sorted((user1, user2) -&gt; user1.name.compareTo(user2.name));
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Now that the long running operation is wrapped in a <code>defer()</code>, we have full control as to what thread this should run in simply by specifying the appropriate <code>Scheduler</code> in <code>subscribeOn()</code>. With this change, our code is fully reactive and subscription should only occur at the moment the data is needed.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * @return a list of users with blogs
</span><span class='line'> */
</span><span class='line'>public Observable&lt;User&gt; getUsersWithBlogs() {
</span><span class='line'>   return Observable.defer(() -&gt; Observable.fromIterable(UserCache.getAllUsers()))
</span><span class='line'>                    .filter(user -&gt; user.blog != null && !user.blog.isEmpty())
</span><span class='line'>                    .sorted((user1, user2) -&gt; user1.name.compareTo(user2.name))
</span><span class='line'>                    .subscribeOn(Schedulers.io());
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Another quite useful operator for deferring computation is the <code>fromCallable()</code> method. Unlike <code>defer()</code>, which expects an Observable to be returned in the lambda function and in turn ‚Äúflattens‚Äù the returned <code>Observable</code>, <code>fromCallable()</code> will invoke the lambda and return the value downstream.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * @return a list of users with blogs
</span><span class='line'> */
</span><span class='line'>public Observable&lt;User&gt; getUsersWithBlogs() {
</span><span class='line'>   final Observable&lt;List&lt;User&gt;&gt; usersObservable = Observable.fromCallable(() -&gt; UserCache.getAllUsers());
</span><span class='line'>   final Observable&lt;User&gt; userObservable = usersObservable.flatMap(users -&gt; Observable.fromIterable(users));
</span><span class='line'>   return userObservable.filter(user -&gt; user.blog != null && !user.blog.isEmpty())
</span><span class='line'>                        .sorted((user1, user2) -&gt; user1.name.compareTo(user2.name));
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Single using <code>fromCallable()</code> on a list would now return an <code>Observable&lt;List&lt;User&gt;&gt;</code>, we need to flatten this list using <code>flatMap()</code>.</p>

<h2>Reactive-everything</h2>

<p>From the previous examples, we have seen that we can wrap any object in an <code>Observable</code> and jump between non-reactive and reactive states using blocking operations and <code>defer()</code>/<code>fromCallable()</code>. Using these constructs, we can start converting areas of an Android app to be reactive.</p>

<h3>Long Operations</h3>

<p>A good place to initially think of using RxJava is whenever you have a process that takes a while to perform, such as network calls (check out <a href="https://www.toptal.com/android/functional-reactive-android-rxjava">previous post</a> for examples), disk reads and writes, etc. The following example illustrates a simple function that will write text to the file system:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Writes {@code text} to the file system.
</span><span class='line'> *
</span><span class='line'> * @param context a Context
</span><span class='line'> * @param filename the name of the file
</span><span class='line'> * @param text the text to write
</span><span class='line'> * @return true if the text was successfully written, otherwise, false
</span><span class='line'> */
</span><span class='line'>public boolean writeTextToFile(Context context, String filename, String text) {
</span><span class='line'>   FileOutputStream outputStream;
</span><span class='line'>   try {
</span><span class='line'>       outputStream = context.openFileOutput(filename, Context.MODE_PRIVATE);
</span><span class='line'>       outputStream.write(text.getBytes());
</span><span class='line'>       outputStream.close();
</span><span class='line'>       return true;
</span><span class='line'>   } catch (Exception e) {
</span><span class='line'>       e.printStackTrace();
</span><span class='line'>       return false;
</span><span class='line'>   }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>When calling this function, we need to make sure that it is done on a separate thread since this operation is blocking. Imposing such a restriction on the caller complicates things for the developer which increases the likelihood of bugs and can potentially slow down development.</p>

<p>Adding a comment to the function will of course help avoid errors by the caller, but that is still far from bulletproof.</p>

<p>Using RxJava, however, we can easily wrap this into an <code>Observable</code> and specify the <code>Scheduler</code> that it should run on. This way, the caller doesn‚Äôt need to be concerned at all with invoking the function in a separate thread; the function will take care of this itself.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Writes {@code text} to the filesystem.
</span><span class='line'> *
</span><span class='line'> * @param context a Context
</span><span class='line'> * @param filename the name of the file
</span><span class='line'> * @param text the text to write
</span><span class='line'> * @return An Observable emitting a boolean indicating whether or not the text was successfully written.
</span><span class='line'> */
</span><span class='line'>public Observable&lt;Boolean&gt; writeTextToFile(Context context, String filename, String text) {
</span><span class='line'>   return Observable.fromCallable(() -&gt; {
</span><span class='line'>       FileOutputStream outputStream;
</span><span class='line'>       outputStream = context.openFileOutput(filename, Context.MODE_PRIVATE);
</span><span class='line'>       outputStream.write(text.getBytes());
</span><span class='line'>       outputStream.close();
</span><span class='line'>       return true;
</span><span class='line'>   }).subscribeOn(Schedulers.io());
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>Using <code>fromCallable()</code>, writing the text to file is deferred up until subscription time.</p>

<p>Since exceptions are first-class objects in RxJava, one other benefit of our change is that the we no longer need to wrap the operation in a try/catch block. The exception will simply be propagated downstream rather than being swallowed. This allows the caller to handle the exception a he/she sees fit (e.g. show an error to the user depending on what exception was thrown, etc.).</p>

<p>One other optimization we can perform is to return a <code>Completable</code> rather than an <code>Observable</code>. A <code>Completable</code> is essentially a special type of <code>Observable</code> ‚Äî similar to a <code>Single</code> ‚Äî that simply indicates if a computation succeeded, via <code>onComplete()</code>, or failed, via <code>onError()</code>. Returning a <code>Completable</code> seems to make more sense in this case since it seems silly to return a single true in an <code>Observable</code> stream.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/**
</span><span class='line'> * Writes {@code text} to the filesystem.
</span><span class='line'> *
</span><span class='line'> * @param context a context
</span><span class='line'> * @param filename the name of the file
</span><span class='line'> * @param text the text to write
</span><span class='line'> * @return A Completable
</span><span class='line'> */
</span><span class='line'>public Completable writeTextToFile(Context context, String filename, String text) {
</span><span class='line'>   return Completable.fromAction(() -&gt; {
</span><span class='line'>       FileOutputStream outputStream;
</span><span class='line'>       outputStream = context.openFileOutput(filename, Context.MODE_PRIVATE);
</span><span class='line'>       outputStream.write(text.getBytes());
</span><span class='line'>       outputStream.close();
</span><span class='line'>   }).subscribeOn(Schedulers.io());
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>To complete the operation, we use the <code>fromAction()</code> operation of a <code>Completable</code> since the return value is no longer of interest to us. If needed, like an <code>Observable</code>, a <code>Completable</code> also supports the <code>fromCallable()</code> and <code>defer()</code> functions.</p>

<h3>Replacing Callbacks</h3>

<p>So far, all the examples that we‚Äôve looked at emit either one value (i.e., can be modelled as a <code>Single</code>), or tell us if an operation succeeded or failed (i.e., can be modelled as a <code>Completable</code>).</p>

<p>How might we convert areas in our app, though, that receive continuous updates or events (such as location updates, view click events, sensor events, and so on)?</p>

<p>We will look at two ways to do this, using <code>create()</code> and using <code>Subjects</code>.</p>

<p><code>create()</code> allows us to explicitly invoke an observer‚Äôs <code>onNext()</code>|<code>onComplete()</code>|<code>onError()</code> method as we receive updates from our data source. To use <code>create()</code>, we pass in an <code>ObservableOnSubscribe</code> which receives an <code>ObservableEmitter</code> whenever an observer subscribes. Using the received emitter, we can then perform all the necessary set-up calls to start receiving updates and then invoke the appropriate <code>Emitter</code> event.</p>

<p>In the case of location updates, we can register to receive updates in this place and emit location updates as received.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class LocationManager {
</span><span class='line'>
</span><span class='line'>   /**
</span><span class='line'>    * Call to receive device location updates.
</span><span class='line'>    * @return An Observable emitting location updates
</span><span class='line'>    */
</span><span class='line'>   public Observable&lt;Location&gt; observeLocation() {
</span><span class='line'>       return Observable.create(emitter -&gt; {
</span><span class='line'>           // Make sure that the following conditions apply and if not, call the emitter's onError() method
</span><span class='line'>           // (1) googleApiClient is connected
</span><span class='line'>           // (2) location permission is granted
</span><span class='line'>           final LocationRequest locationRequest = new LocationRequest();
</span><span class='line'>           locationRequest.setInterval(1000);
</span><span class='line'>           locationRequest.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);
</span><span class='line'>
</span><span class='line'>           LocationServices.FusedLocationApi.requestLocationUpdates(googleApiClient, locationRequest, new LocationListener() {
</span><span class='line'>               @Override public void onLocationChanged(Location location) {
</span><span class='line'>                   if (!emitter.isDisposed()) {
</span><span class='line'>                       emitter.onNext(location);
</span><span class='line'>                   }
</span><span class='line'>               }
</span><span class='line'>           });
</span><span class='line'>       });
</span><span class='line'>   }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>The function inside the <code>create()</code> call requests location updates and passes in a callback that gets invoked when the device‚Äôs location changes. As we can see here, we essentially replace the callback-style interface and instead emit the received location in the created Observable stream (for the sake of educational purposes, I skipped some of the details with constructing a location request, if you want to delve deeper into the details you can read it <a href="https://developer.android.com/training/location/receive-location-updates.html">here</a>).</p>

<p>One other thing to note about <code>create()</code> is that, whenever <code>subscribe()</code> is called, a new emitter is provided. In other words, <code>create()</code> returns a <a href="https://medium.com/@benlesh/hot-vs-cold-observables-f8094ed53339">cold Observable</a>. This means that, in the function above, we would potentially be requesting location updates multiple times, which is not what we want.</p>

<p>To work around this, we want to change the the function to return a hot <code>Observable</code> with the help of <code>Subjects</code>.</p>

<h3>Enter Subjects</h3>

<p>A <code>Subject</code> extends an <code>Observable</code> and implements <code>Observer</code> at the same time. This is particularly useful whenever we want to emit or cast the same event to multiple subscribers at the same time. Implementation-wise, we would want to expose the <code>Subject</code> as an <code>Observable</code> to clients, while keeping it as a <code>Subject</code> for the provider.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>public class LocationManager {
</span><span class='line'>
</span><span class='line'>   private Subject&lt;Location&gt; locationSubject = PublishSubject.create();
</span><span class='line'>   
</span><span class='line'>   /**
</span><span class='line'>    * Invoke this method when this LocationManager should start listening to location updates.
</span><span class='line'>    */
</span><span class='line'>   public void connect() {
</span><span class='line'>       final LocationRequest locationRequest = new LocationRequest();
</span><span class='line'>       locationRequest.setInterval(1000);
</span><span class='line'>       locationRequest.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);
</span><span class='line'>
</span><span class='line'>       LocationServices.FusedLocationApi.requestLocationUpdates(googleApiClient, locationRequest, new LocationListener() {
</span><span class='line'>           @Override public void onLocationChanged(Location location) {
</span><span class='line'>               locationSubject.onNext(location);
</span><span class='line'>           }
</span><span class='line'>       });
</span><span class='line'>   }
</span><span class='line'>   
</span><span class='line'>   /**
</span><span class='line'>    * Call to receive device location updates.
</span><span class='line'>    * @return An Observable emitting location updates
</span><span class='line'>    */
</span><span class='line'>   public Observable&lt;Location&gt; observeLocation() {
</span><span class='line'>       return locationSubject;
</span><span class='line'>   }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>In this new implementation, the subtype <code>PublishSubject</code> is used which emits events as they arrive starting from the time of subscription. Accordingly, if a subscription is performed at a point when location updates have already been emitted, past emissions will not be received by the observer, only subsequent ones. If this behavior is not desired, there are a couple of other <code>Subject</code> subtypes in the RxJava toolkit that can be <a href="http://reactivex.io/documentation/subject.html">used</a>.</p>

<p><img class="center" src="http://chrisarriola.me/images/rxjava_publish_subject.jpg"></p>

<p>In addition, we also created a separate <code>connect()</code> function which starts the request to receive location updates. The <code>observeLocation()</code> can still do the <code>connect()</code> call, but we refactored it out of the function for clarity/simplicity.</p>

<h2>Summary</h2>

<p>We‚Äôve looked at a number of mechanisms and techniques:</p>

<ul>
<li><code>defer()</code> and its variants to delay execution of a computation until subscription</li>
<li>cold <code>Observables</code> generated through <code>create()</code></li>
<li>hot <code>Observables</code> using <code>Subjects</code></li>
<li><code>blockingX()</code> operations when we want to leave the reactive world</li>
</ul>


<p>Hopefully, the examples provided in this article inspired some ideas regarding different areas in your app that can be converted to be reactive. We‚Äôve covered a lot and if you have any questions, suggestions, or if anything is not clear, feel free to leave a comment below!</p>

<p>If you are interested in learning more about RxJava, I am working on an in-depth book that explains how to view problems the reactive way using Android examples. If you‚Äôd like to receive updates on it, please subscribe <a href="https://leanpub.com/reactiveandroid">here</a>.</p>

<p><img class="center" src="http://chrisarriola.me/images/rxjava_my_book.jpg"></p>

      
      
    </div>
  </div>



    </article>
    
  
  <div class="pagination">
    
    <a class="prev" href="/blog/page/2/">&larr; Older</a>
    

    
  </div>
</div>


        </div>
      </div>
      <div class="row-fluid">
        <footer class="footer-page" role="contentinfo">
          


        </footer>
      </div>
  </div>
  

<script type="text/javascript">
      var disqus_shortname = 'chrisarriola';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




<div class="after-footer">
    <div class="after-footer-inner">
        <section>
            <h2>Keep In Touch</h2>
            <p>
            Want to know when a new article comes out?
            </p>
            <form action="//chrisarriola.us10.list-manage.com/subscribe/post?u=f57ac58f6cfb6b88bb2ec77f3&amp;id=91c15e4ccc" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" target="_blank">
                <input type="text" placeholder="Your Email Here" autocomplete="off" name="EMAIL" id="mce-EMAIL">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn btn-subscribe">
            </form>
        </section>
        
        <p>
        Copyright &copy; 2017 - Chris Arriola -
        <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
        </p>
    </div>
</div>
<script type="text/javascript" src="//s3.amazonaws.com/downloads.mailchimp.com/js/signup-forms/popup/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">require(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us10.list-manage.com","uuid":"f57ac58f6cfb6b88bb2ec77f3","lid":"91c15e4ccc"}) })</script>


</body>
</html>
